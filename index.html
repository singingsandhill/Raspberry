<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deploy Â· GitHub Actions</title>
    <style>
    :root{
        --bg:#0b1220;--fg:#e5e7eb;--muted:#9ca3af;--accent:#7c3aed;--ok:#10b981;--err:#ef4444;--warn:#f59e0b
      }
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;padding:0}
      body{display:grid;place-items:center;background:radial-gradient(800px 500px at 10% 0%, #121a2f, #0b1220);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:20px}
      .card{width:min(90vw, 1200px);background:rgba(255,255,255,.04);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:22px}
      h1{margin:0 0 8px;font-size:18px}
      p{margin:0 0 12px;color:var(--muted);font-size:14px}
      .input-group{margin-bottom:14px}
      .input-group label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--fg)}
      .input-group input{width:100%;padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--fg);font-size:14px;font-family:ui-monospace,Menlo,Consolas,monospace}
      .input-group input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,.08)}
      .btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:800;letter-spacing:.2px;cursor:pointer;background:linear-gradient(180deg,var(--accent),#6d28d9);color:white;box-shadow:0 10px 20px rgba(124,58,237,.35);width:100%;margin-top:8px}
      .btn[disabled]{opacity:.6;cursor:not-allowed}
      .btn-secondary{background:linear-gradient(180deg,#374151,#1f2937);box-shadow:0 10px 20px rgba(0,0,0,.2)}
      .status{margin-top:14px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;word-break:break-all}
      .ok{color:var(--ok)}
      .err{color:var(--err)}
      .warn{color:var(--warn)}
      .hint{margin-top:10px;padding:10px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;font-size:12px;color:#fca5a5}
      .kbd{font-family:ui-monospace,Menlo,monospace;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-bottom-width:2px;padding:1px 6px;border-radius:6px}
      .small{font-size:12px}
      .token-saved{display:none;align-items:center;gap:8px;padding:8px 12px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:8px;font-size:12px;color:var(--ok);margin-bottom:12px}
      .token-saved.show{display:flex}
      .iframe-container{margin-top:20px}
      .iframe-container h3{margin:0 0 10px;font-size:16px;color:var(--fg)}
      .iframe-container iframe{width:100%;height:400px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.02)}
      .link{color:var(--accent);text-decoration:none;font-weight:600}
      .link:hover{text-decoration:underline}
      .workflow-monitor{margin-top:20px;padding:20px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px}
      .monitor-controls{display:flex;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.08)}
      .workflow-runs{display:grid;gap:12px}
      .workflow-run{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:12px}
      .workflow-run h4{margin:0 0 8px;font-size:14px;display:flex;align-items:center;gap:8px}
      .workflow-status{padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
      .status-queued{background:rgba(156,163,175,.2);color:#9ca3af}
      .status-in_progress{background:rgba(251,191,36,.2);color:#fbbf24}
      .status-completed{background:rgba(16,185,129,.2);color:#10b981}
      .status-failure{background:rgba(239,68,68,.2);color:#ef4444}
      .jobs-grid{display:grid;gap:8px;margin-top:10px}
      .job-item{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:8px;cursor:pointer;transition:background .2s}
      .job-item:hover{background:rgba(255,255,255,.08)}
      .job-item-header{display:flex;justify-content:between;align-items:center;font-size:12px}
      .job-name{font-weight:600}
      .job-duration{color:var(--muted);font-size:11px}
      .log-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;z-index:1000;padding:20px}
      .log-content{width:100%;height:100%;background:var(--bg);border:1px solid rgba(255,255,255,.12);border-radius:12px;display:flex;flex-direction:column}
      .log-header{padding:15px 20px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:between;align-items:center}
      .log-body{flex:1;padding:15px 20px;overflow-y:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.5;white-space:pre-wrap}
      .close-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px}
      .close-btn:hover{color:var(--fg)}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>ğŸš€ GitHub Actions ë°°í¬ íŠ¸ë¦¬ê±°</h1>
      <p class="small">ë²„íŠ¼ í•˜ë‚˜ë¡œ <span class="kbd">workflow_dispatch</span> ì´ë²¤íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p>

      <div id="tokenSaved" class="token-saved">
        <span>âœ“</span>
        <span>í† í°ì´ Session Storageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (íƒ­ ë‹«ìœ¼ë©´ ì‚­ì œ)</span>
      </div>

      <div class="input-group">
        <label for="tokenInput">
          GitHub Personal Access Token
        </label>
        <input 
          type="password" 
          id="tokenInput" 
          placeholder="ghp_xxxxxxxxxxxxxxxxxx"
          autocomplete="off"
        />
      </div>

      <button id="saveBtn" class="btn btn-secondary" type="button">ğŸ’¾ í† í° ì €ì¥ (Session Storage)</button>
      <button id="deployBtn" class="btn" type="button">ğŸš€ ë°°í¬ ì‹¤í–‰</button>
      
      <div id="status" class="status" role="status" aria-live="polite">ëŒ€ê¸° ì¤‘â€¦</div>
      
      <div class="hint">
        <strong>âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­:</strong><br>
        â€¢ Personal Access Tokenì€ <strong>Actions: write</strong>, <strong>Contents: read</strong>, <strong>Metadata: read</strong> ê¶Œí•œ í•„ìš”<br>
        â€¢ í† í°ì€ sessionStorageì—ë§Œ ì €ì¥ (íƒ­ ë‹«ìœ¼ë©´ ìë™ ì‚­ì œ)<br>
        â€¢ <strong>ì ˆëŒ€ í† í°ì„ ê³µìœ í•˜ê±°ë‚˜ ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”</strong><br>
        â€¢ Fine-grained token ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤
      </div>
      
      <div id="workflowMonitor" class="workflow-monitor" style="display: none;">
        <h3>ğŸ“Š ì›Œí¬í”Œë¡œìš° ëª¨ë‹ˆí„°ë§</h3>
        <div class="monitor-controls">
          <button id="refreshBtn" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          <label style="margin-left: 10px; font-size: 12px;">
            <input type="checkbox" id="autoRefresh" /> ìë™ ìƒˆë¡œê³ ì¹¨ (10ì´ˆ)
          </label>
        </div>
        <div id="workflowRuns" class="workflow-runs"></div>
      </div>

      <div class="iframe-container">
        <h3>ğŸŒ Eureka Service Registry</h3>
        <iframe src="https://hyang.store/" title="Eureka Server Dashboard" frameborder="0"></iframe>
      </div>
    </div>

    <!-- ë¡œê·¸ ëª¨ë‹¬ -->
    <div id="logModal" class="log-modal">
      <div class="log-content">
        <div class="log-header">
          <h3 id="logTitle">Job ë¡œê·¸</h3>
          <button id="closeModal" class="close-btn">âœ•</button>
        </div>
        <div id="logBody" class="log-body">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <script>
      // ====== ë ˆí¬ì§€í† ë¦¬ ì„¤ì • (ìˆ˜ì • í•„ìš”) ======
      const CONFIG = {
        owner: 'SoftBankHackathon2025',             // GitHub ì‚¬ìš©ìëª…
        repo: 'Raspberry',        // ë ˆí¬ì§€í† ë¦¬ëª…
        workflows: ['ci-cd.yml', 'code-scanning-improved.yml'],  // ì‹¤í–‰í•  ì›Œí¬í”Œë¡œìš°ë“¤
        ref: 'main'                           // ë¸Œëœì¹˜ëª…
      };
      // ========================================

      const $ = (s) => document.querySelector(s);
      const statusEl = $('#status');
      const deployBtn = $('#deployBtn');
      const saveBtn = $('#saveBtn');
      const tokenInput = $('#tokenInput');
      // const envInput = $('#envInput');
      const tokenSaved = $('#tokenSaved');
      const workflowMonitor = $('#workflowMonitor');
      const workflowRuns = $('#workflowRuns');
      const refreshBtn = $('#refreshBtn');
      const autoRefresh = $('#autoRefresh');
      const logModal = $('#logModal');
      const logTitle = $('#logTitle');
      const logBody = $('#logBody');
      const closeModal = $('#closeModal');
      
      let pollingInterval = null;
      let currentRuns = [];
      let triggerTime = null; // ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì‹œì  ì €ì¥

      function setStatus(text, cls){
        statusEl.className = 'status' + (cls ? ' ' + cls : '');
        statusEl.textContent = text;
      }

      // ì„¸ì…˜ì—ì„œ í† í° ë¡œë“œ
      function loadToken(){
        const saved = sessionStorage.getItem('gh_token');
        if(saved){
          tokenInput.value = saved;
          tokenSaved.classList.add('show');
        }
      }

      // í† í° ì €ì¥
      saveBtn.addEventListener('click', function(){
        const token = tokenInput.value.trim();
        if(!token){
          setStatus('âŒ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'err');
          return;
        }
        sessionStorage.setItem('gh_token', token);
        tokenSaved.classList.add('show');
        setStatus('âœ… í† í°ì´ ì„¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'ok');
      });

      // ë°°í¬ íŠ¸ë¦¬ê±°
      async function triggerDispatch(){
        const token = tokenInput.value.trim();
        // const environment = envInput.value.trim() || 'stg';
        
        if(!token){
          setStatus('âŒ GitHub Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'err');
          tokenInput.focus();
          return;
        }

        deployBtn.disabled = true;
        setStatus('ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘â€¦');
        
        // íŠ¸ë¦¬ê±° ì‹œì  ì €ì¥ (í˜„ì¬ ì‹œê°„)
        triggerTime = new Date();

        const {owner, repo, workflows, ref} = CONFIG;
        let successCount = 0;
        let failCount = 0;
        const results = [];

        // ëª¨ë“  ì›Œí¬í”Œë¡œìš°ë¥¼ ë™ì‹œì— ì‹¤í–‰
        setStatus(`ëª¨ë“  ì›Œí¬í”Œë¡œìš° ë™ì‹œ ì‹¤í–‰ ì¤‘... (${workflows.length}ê°œ)`);

        // ê° ì›Œí¬í”Œë¡œìš°ì— ëŒ€í•œ Promise ìƒì„±
        const workflowPromises = workflows.map(async (workflow_id) => {
          const workflowName = workflow_id.replace('.yml', '');
          const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflow_id}/dispatches`;
          
          // ëª¨ë“  ì›Œí¬í”Œë¡œìš°ì— ë¹ˆ ê°ì²´ ì „ì†¡ (ì…ë ¥ ë§¤ê°œë³€ìˆ˜ ì—†ìŒ)
          let inputs = {};
          
          try {
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'Accept': 'application/vnd.github+json',
                'Authorization': `Bearer ${token}`,
                'X-GitHub-Api-Version': '2022-11-28',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ 
                ref,
                inputs
              })
            });

            if(res.status === 204){
              return { success: true, name: workflowName, message: `âœ… ${workflowName}: ì„±ê³µ` };
            } else {
              const text = await res.text();
              let errorMsg = `HTTP ${res.status}`;
              try {
                const json = JSON.parse(text);
                errorMsg += ` â€” ${json.message || text}`;
              } catch {
                errorMsg += ` â€” ${text || 'ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ'}`;
              }
              return { success: false, name: workflowName, message: `âŒ ${workflowName}: ${errorMsg}` };
            }
          } catch (e){
            return { success: false, name: workflowName, message: `âŒ ${workflowName}: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ - ${e?.message || e}` };
          }
        });

        // ëª¨ë“  ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸°
        const workflowResults = await Promise.allSettled(workflowPromises);
        
        // ê²°ê³¼ ì²˜ë¦¬
        workflowResults.forEach((result, index) => {
          if (result.status === 'fulfilled') {
            const { success, message } = result.value;
            if (success) {
              successCount++;
            } else {
              failCount++;
            }
            results.push(message);
          } else {
            // Promise ìì²´ê°€ ê±°ë¶€ëœ ê²½ìš°
            const workflowName = workflows[index].replace('.yml', '');
            failCount++;
            results.push(`âŒ ${workflowName}: Promise ì‹¤í–‰ ì‹¤íŒ¨ - ${result.reason}`);
          }
        });

        // ìµœì¢… ê²°ê³¼ í‘œì‹œ
        const totalWorkflows = workflows.length;
        if (failCount === 0) {
          setStatus(`âœ… ëª¨ë“  ì›Œí¬í”Œë¡œìš° ì„±ê³µ! (${successCount}/${totalWorkflows})`, 'ok');
        } else if (successCount > 0) {
          setStatus(`âš ï¸ ì¼ë¶€ ì„±ê³µ: ${successCount}/${totalWorkflows} (${failCount}ê°œ ì‹¤íŒ¨)`, 'warn');
        } else {
          setStatus(`âŒ ëª¨ë“  ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ (${failCount}/${totalWorkflows})`, 'err');
        }

        // 2ì´ˆ í›„ ìƒì„¸ ê²°ê³¼ì™€ ë§í¬ í‘œì‹œ
        setTimeout(() => {
          const actionsUrl = `https://github.com/${owner}/${repo}/actions`;
          const detailMsg = results.join(' | ') + `\nGitHub Actions: ${actionsUrl}`;
          setStatus(detailMsg, failCount === 0 ? 'ok' : (successCount > 0 ? 'warn' : 'err'));
        }, 2000);

        deployBtn.disabled = false;
        
        // 5ì´ˆ í›„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (GitHub API ë°˜ì˜ ì‹œê°„ í™•ë³´)
        setTimeout(() => {
          startWorkflowMonitoring();
        }, 5000);
      }

      // ì›Œí¬í”Œë¡œìš° ëª¨ë‹ˆí„°ë§ ì‹œì‘
      function startWorkflowMonitoring() {
        workflowMonitor.style.display = 'block';
        fetchWorkflowRuns();
        
        if (autoRefresh.checked) {
          clearInterval(pollingInterval);
          pollingInterval = setInterval(fetchWorkflowRuns, 10000);
        }
      }

      // ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      async function fetchWorkflowRuns() {
        const token = tokenInput.value.trim();
        if (!token) return;

        const { owner, repo, workflows } = CONFIG;
        
        try {
          const allRuns = [];
          
          // ê° ì›Œí¬í”Œë¡œìš°ì˜ ìµœê·¼ ì‹¤í–‰ë“¤ ê°€ì ¸ì˜¤ê¸°
          for (const workflow of workflows) {
            const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflow}/runs?per_page=5`;
            const res = await fetch(url, {
              headers: {
                'Accept': 'application/vnd.github+json',
                'Authorization': `Bearer ${token}`,
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });
            
            if (res.ok) {
              const data = await res.json();
              // íŠ¸ë¦¬ê±° ì‹œì  ì´í›„ì— ìƒì„±ëœ ì›Œí¬í”Œë¡œìš°ë§Œ í•„í„°ë§
              let filteredRuns = data.workflow_runs;
              if (triggerTime) {
                filteredRuns = data.workflow_runs.filter(run => {
                  const runCreatedAt = new Date(run.created_at);
                  const timeDiff = runCreatedAt - triggerTime;
                  // ì¡°ê±´: íŠ¸ë¦¬ê±° ì‹œì  ì´í›„ ìƒì„± + í˜„ì¬ ë¸Œëœì¹˜ì™€ ì¼ì¹˜
                  const isAfterTrigger = timeDiff >= -30000 && timeDiff <= 300000; // -30ì´ˆ ~ +5ë¶„
                  const isSameBranch = run.head_branch === CONFIG.ref || run.head_branch === CONFIG.ref.replace('refs/heads/', '');
                  return isAfterTrigger && isSameBranch;
                });
              }
              allRuns.push(...filteredRuns.map(run => ({ ...run, workflow_name: workflow })));
            }
          }
          
          // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
          allRuns.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          currentRuns = allRuns.slice(0, 10); // ìµœê·¼ 10ê°œë§Œ
          
          displayWorkflowRuns();
        } catch (error) {
          console.error('ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        }
      }

      // ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ëª©ë¡ í‘œì‹œ
      function displayWorkflowRuns() {
        workflowRuns.innerHTML = '';
        
        if (currentRuns.length === 0) {
          let message = 'ì‹¤í–‰ ì¤‘ì¸ ì›Œí¬í”Œë¡œìš°ê°€ ì—†ìŠµë‹ˆë‹¤.';
          if (triggerTime) {
            const triggerTimeStr = triggerTime.toLocaleTimeString('ko-KR');
            message = `${triggerTimeStr} ì´í›„ ì‹¤í–‰ëœ ì›Œí¬í”Œë¡œìš°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
          }
          workflowRuns.innerHTML = `<div style="text-align:center;color:var(--muted);padding:20px;">${message}</div>`;
          return;
        }
        
        currentRuns.forEach(run => {
          const runEl = createWorkflowRunElement(run);
          workflowRuns.appendChild(runEl);
        });
      }

      // ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìš”ì†Œ ìƒì„±
      function createWorkflowRunElement(run) {
        const div = document.createElement('div');
        div.className = 'workflow-run';
        
        const statusClass = `status-${run.status}${run.conclusion ? '_' + run.conclusion : ''}`;
        const statusText = run.status === 'completed' ? run.conclusion : run.status;
        const duration = run.updated_at ? formatDuration(new Date(run.created_at), new Date(run.updated_at)) : 'ì§„í–‰ ì¤‘';
        
        div.innerHTML = `
          <h4>
            ${getWorkflowIcon(run.workflow_name)} ${run.workflow_name.replace('.yml', '')}
            <span class="workflow-status ${statusClass}">${statusText}</span>
          </h4>
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 10px;">
            #${run.run_number} â€¢ ${formatDate(run.created_at)} â€¢ ${duration}
          </div>
          <div class="jobs-grid" id="jobs-${run.id}">
            <div style="text-align: center; padding: 10px; color: var(--muted);">Job ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        `;
        
        // Job ì •ë³´ ë¹„ë™ê¸° ë¡œë“œ
        fetchJobsForRun(run.id);
        
        return div;
      }

      // íŠ¹ì • ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì˜ Job ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      async function fetchJobsForRun(runId) {
        const token = tokenInput.value.trim();
        if (!token) return;

        const { owner, repo } = CONFIG;
        const url = `https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}/jobs`;
        
        try {
          const res = await fetch(url, {
            headers: {
              'Accept': 'application/vnd.github+json',
              'Authorization': `Bearer ${token}`,
              'X-GitHub-Api-Version': '2022-11-28'
            }
          });
          
          if (res.ok) {
            const data = await res.json();
            displayJobs(runId, data.jobs);
          }
        } catch (error) {
          console.error('Job ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
          const jobsContainer = document.getElementById(`jobs-${runId}`);
          if (jobsContainer) {
            jobsContainer.innerHTML = '<div style="color: var(--err);">Job ì •ë³´ ë¡œë“œ ì‹¤íŒ¨</div>';
          }
        }
      }

      // Job ëª©ë¡ í‘œì‹œ
      function displayJobs(runId, jobs) {
        const jobsContainer = document.getElementById(`jobs-${runId}`);
        if (!jobsContainer) return;
        
        jobsContainer.innerHTML = '';
        
        jobs.forEach(job => {
          const jobEl = document.createElement('div');
          jobEl.className = 'job-item';
          
          const statusClass = `status-${job.status}${job.conclusion ? '_' + job.conclusion : ''}`;
          const statusText = job.status === 'completed' ? job.conclusion : job.status;
          const duration = job.completed_at ? formatDuration(new Date(job.started_at), new Date(job.completed_at)) : 'ì§„í–‰ ì¤‘';
          
          jobEl.innerHTML = `
            <div class="job-item-header">
              <span class="job-name">${job.name}</span>
              <span class="workflow-status ${statusClass}">${statusText}</span>
            </div>
            <div class="job-duration">${duration}</div>
          `;
          
          // í´ë¦­ ì‹œ ë¡œê·¸ ëª¨ë‹¬ ì—´ê¸°
          jobEl.addEventListener('click', () => openLogModal(job));
          
          jobsContainer.appendChild(jobEl);
        });
      }

      // ë¡œê·¸ ëª¨ë‹¬ ì—´ê¸°
      async function openLogModal(job) {
        logTitle.textContent = `${job.name} ë¡œê·¸`;
        logBody.textContent = 'ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        logModal.style.display = 'block';
        
        const token = tokenInput.value.trim();
        if (!token) {
          logBody.textContent = 'âŒ GitHub Tokenì´ í•„ìš”í•©ë‹ˆë‹¤.';
          return;
        }

        try {
          const { owner, repo } = CONFIG;
          const url = `https://api.github.com/repos/${owner}/${repo}/actions/jobs/${job.id}/logs`;
          
          const res = await fetch(url, {
            headers: {
              'Accept': 'application/vnd.github+json',
              'Authorization': `Bearer ${token}`,
              'X-GitHub-Api-Version': '2022-11-28'
            }
          });
          
          if (res.ok) {
            const logText = await res.text();
            // ANSI ìƒ‰ìƒ ì½”ë“œ ì œê±° ë° ê¸°ë³¸ í¬ë§·íŒ…
            const cleanLog = logText
              .replace(/\x1B\[[0-9;]*[JKmsu]/g, '') // ANSI escape codes ì œê±°
              .replace(/##\[group\].*?\n/g, '') // GitHub Actions group markers ì œê±°
              .replace(/##\[endgroup\]\n/g, '')
              .replace(/##\[section\].*?\n/g, '')
              .replace(/##\[endsection\]\n/g, '');
            
            logBody.textContent = cleanLog || 'ë¡œê·¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.';
          } else if (res.status === 302) {
            // ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬
            const location = res.headers.get('Location');
            if (location) {
              const logRes = await fetch(location);
              if (logRes.ok) {
                const logText = await logRes.text();
                const cleanLog = logText
                  .replace(/\x1B\[[0-9;]*[JKmsu]/g, '')
                  .replace(/##\[group\].*?\n/g, '')
                  .replace(/##\[endgroup\]\n/g, '');
                logBody.textContent = cleanLog || 'ë¡œê·¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.';
              } else {
                throw new Error('ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
              }
            } else {
              throw new Error('ë¡œê·¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
          } else {
            const errorText = await res.text();
            throw new Error(`HTTP ${res.status}: ${errorText}`);
          }
        } catch (error) {
          console.error('ë¡œê·¸ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
          logBody.textContent = `âŒ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
        }
      }

      // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
      function getWorkflowIcon(workflowName) {
        if (workflowName.includes('ci-cd')) return 'ğŸš€';
        if (workflowName.includes('scan')) return 'ğŸ”';
        return 'âš™ï¸';
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        
        if (minutes < 1) return 'ë°©ê¸ˆ ì „';
        if (minutes < 60) return `${minutes}ë¶„ ì „`;
        if (minutes < 1440) return `${Math.floor(minutes / 60)}ì‹œê°„ ì „`;
        return date.toLocaleDateString('ko-KR');
      }

      function formatDuration(start, end) {
        const diff = end - start;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        
        if (minutes > 0) {
          return `${minutes}ë¶„ ${seconds % 60}ì´ˆ`;
        }
        return `${seconds}ì´ˆ`;
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
      deployBtn.addEventListener('click', triggerDispatch);
      
      refreshBtn.addEventListener('click', function() {
        // Shift í´ë¦­ ì‹œ í•„í„° ì´ˆê¸°í™” (ëª¨ë“  ì›Œí¬í”Œë¡œìš° í‘œì‹œ)
        if (event.shiftKey) {
          triggerTime = null;
          setStatus('í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  ì›Œí¬í”Œë¡œìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.', 'ok');
        }
        fetchWorkflowRuns();
      });
      
      autoRefresh.addEventListener('change', function() {
        if (this.checked) {
          pollingInterval = setInterval(fetchWorkflowRuns, 10000);
        } else {
          clearInterval(pollingInterval);
        }
      });
      
      closeModal.addEventListener('click', function() {
        logModal.style.display = 'none';
      });
      
      logModal.addEventListener('click', function(e) {
        if (e.target === logModal) {
          logModal.style.display = 'none';
        }
      });
      
      // ì—”í„°í‚¤ë¡œ ë°°í¬
      // tokenInput.addEventListener('keypress', (e) => {
      //   if(e.key === 'Enter') triggerDispatch();
      // });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ë³µì›
      loadToken();
    </script>
  </body>
</html>