name: CI/CD Pipeline for Microservices

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  DOCKER_REGISTRY: kwa06001
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run Tests
        run: ./gradlew test

  docker-build-scan-push:
    name: Docker Build, Scan & Push
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [server, gateway, fe, deploy, user]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image for ${{ matrix.service }}
        run: |
          IMAGE_NAME="${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}"
          docker build \
            -t $IMAGE_NAME:${{ env.IMAGE_TAG }} \
            -t $IMAGE_NAME:latest \
            -f ./${{ matrix.service }}/Dockerfile \
            .

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'

      - name: Run Trivy Scan (Table Format)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: Push Docker Images
        run: |
          IMAGE_NAME="${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}"
          docker push $IMAGE_NAME:${{ env.IMAGE_TAG }}
          docker push $IMAGE_NAME:latest
          echo "âœ… Pushed: $IMAGE_NAME:${{ env.IMAGE_TAG }} and latest"

  deploy-to-ec2:
    name: Deploy to EC2
    needs: docker-build-scan-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update docker-compose.yml to use images
        run: |
          sed -i "s|build:\s*context: \.|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/server/! s|build:\s*./server|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/server\/Dockerfile/d" docker-compose.yml
          
          sed -i "s|build:\s*context: \.|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/gateway/! s|build:\s*./gateway|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/gateway\/Dockerfile/d" docker-compose.yml

          sed -i "s|build:\s*context: \.|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/fe/! s|build:\s*./fe|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/fe\/Dockerfile/d" docker-compose.yml
          
          sed -i "s|build:\s*context: \.|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/deploy/! s|build:\s*./deploy|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/deploy\/Dockerfile/d" docker-compose.yml
          
          sed -i "s|build:\s*context: \.|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/user/! s|build:\s*./user|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/user\/Dockerfile/d" docker-compose.yml
          
          echo "ğŸ“ Updated docker-compose.yml (to use images instead of build):"
          cat docker-compose.yml

      # AWS ìê²©ì¦ëª… ì„¤ì •
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # AWS SSM Run Commandë¡œ ë°°í¬
      - name: Deploy to EC2 via AWS SSM
        run: |
          COMMAND_SCRIPT='''
          #!/bin/bash
          set -e
          
          echo "ğŸ“‚ Navigating to project directory..."
          cd /home/ubuntu/Raspberry # EC2 ë‚´ í”„ë¡œì íŠ¸ ê²½ë¡œ
          
          echo "ğŸ”§ Changing file ownership..."
          sudo chown -R $USER:$USER .
          
          echo "ğŸ”„ Pulling latest code..."
          git fetch origin 
          git reset --hard origin/${{ github.ref_name }}
          
          # === ğŸ’¡ ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì„¤ì • === (ì´í•˜ ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš© ìœ ì§€)
          if [ -f /swapfile ]; then
            echo "â„¹ Swap file /swapfile already exists."
          else
            echo "ğŸš€ Creating 2G swap file..."
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
          fi
          if ! sudo swapon --show | grep -q "/swapfile"; then
            echo "ğŸŸ¢ Activating swap..."
            sudo swapon /swapfile
          fi
          if ! grep -q "/swapfile" /etc/fstab; then
            echo "âœ Adding swap to /etc/fstab..."
            echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab
          fi
          echo "ğŸ“Š Current swap status:"
          sudo swapon --show
          free -h
          # === ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì„¤ì • ë ===
          
          echo "ğŸ³ Logging in to Docker Hub..."
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          
          echo "ğŸ”§ Granting Docker socket permissions..."
          sudo chmod 666 /var/run/docker.sock
          
          # [!!] EC2ì—ì„œ ì§ì ‘ sed ì‹¤í–‰ [!!]
          echo "ğŸ”§ Updating docker-compose.yml on EC2 to use images..."
          sed -i "s|build:\s*context: \.|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/server/! s|build:\s*./server|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/server\/Dockerfile/d" docker-compose.yml
          
          sed -i "s|build:\s*context: \.|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/gateway/! s|build:\s*./gateway|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/gateway\/Dockerfile/d" docker-compose.yml

          sed -i "s|build:\s*context: \.|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/fe/! s|build:\s*./fe|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/fe\/Dockerfile/d" docker-compose.yml
          
          sed -i "s|build:\s*context: \.|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/deploy/! s|build:\s*./deploy|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/deploy\/Dockerfile/d" docker-compose.yml
          
          sed -i "s|build:\s*context: \.|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/image: kwa06001\/user/! s|build:\s*./user|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "/dockerfile: \.\/user\/Dockerfile/d" docker-compose.yml
          
          echo "ğŸ“¥ Pulling latest Docker images from Docker Hub..."
          docker-compose pull
          
          echo "ğŸ›‘ Stopping and removing corrupted containers..."
          docker-compose down
          
          echo "ğŸš€ Starting services with new images..."
          docker-compose up -d --remove-orphans
          
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -a -f
          
          echo "â³ Waiting for services to start..."
          sleep 15
          
          echo "âœ… Deployment completed!"
          docker-compose ps
          ''' # ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: COMMAND_SCRIPTì™€ ê°™ì€ ì—´ì— ìœ„ì¹˜
          
          # ğŸ’¡ COMMAND_SCRIPTì˜ ë‚´ìš©ì„ JSON í˜•íƒœë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
          ESCAPED_SCRIPT=$(echo "$COMMAND_SCRIPT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | awk '{printf "%s\\n", $0}')
          
          # ğŸ’¡ SSM ëª…ë ¹ JSON íŒŒì¼ ìƒì„± (commandsëŠ” string arrayì—¬ì•¼ í•¨)
          echo '{"Parameters": {"commands": ["'"$ESCAPED_SCRIPT"'"]}}' > ssm_command_params.json
          
          # ğŸ’¡ AWS CLI í˜¸ì¶œ ì‹œ JSON íŒŒì¼ ì§ì ‘ ì‚¬ìš©
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --cli-input-json file://ssm_command_params.json \
            --timeout-seconds 600 \
            --output text

      # AWS SSMìœ¼ë¡œ ë°°í¬ ê²€ì¦
      - name: Verify Deployment
        run: |
          VERIFY_SCRIPT='''
          #!/bin/bash
          set -e
          
          echo "â³ Waiting for services to initialize..."
          sleep 50
          
          cd /home/ubuntu/Raspberry
          
          echo "ğŸ” Checking service health..."
          
          if curl -sf http://localhost:8761 > /dev/null 2>&1; then
          echo "âœ… Eureka Server is healthy"
          else
          echo "âŒ Eureka Server health check failed"
          exit 1
          fi
          
          if curl -sf http://localhost:8080/actuator/health > /dev/null 2>&1; then
          echo "âœ… Gateway is healthy"
          else
          echo "âš  Gateway health check failed"
          fi
          
          echo "ğŸ“Š Service Status:"
          docker-compose ps
          '''
          
          # ğŸ’¡ COMMAND_SCRIPTì˜ ë‚´ìš©ì„ JSON í˜•íƒœë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
          ESCAPED_SCRIPT=$(echo "$VERIFY_SCRIPT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | awk '{printf "%s\\n", $0}')
          
          # ğŸ’¡ SSM ëª…ë ¹ JSON íŒŒì¼ ìƒì„± (commandsëŠ” string arrayì—¬ì•¼ í•¨)
          echo '{"Parameters": {"commands": ["'"$ESCAPED_VERIFY_SCRIPT"'"]}}' > ssm_verify_params.json
          
          # ğŸ’¡ AWS CLI í˜¸ì¶œ ì‹œ JSON íŒŒì¼ ì§ì ‘ ì‚¬ìš©
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --cli-input-json file://ssm_verify_params.json \
            --timeout-seconds 600 \
            --output text

      # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful to EC2"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
