name: Code Static Analysis (SAST)

on:
  push:
    branches:
        - main
  pull_request:
    branches:
        - main
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: '0 2 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ (ì„ íƒì‚¬í•­)

jobs:
  semgrep_scan:
    name: Run Semgrep SAST Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read       # ì½”ë“œë¥¼ Checkout í•˜ê¸° ìœ„í•¨
      security-events: write # GitHub Security íƒ­ì— SARIF ê²°ê³¼ë¥¼ ì—…ë¡œë“œí•˜ê¸° ìœ„í•¨
      actions: read        # ì›Œí¬í”Œë¡œìš° ì •ë³´ ì½ê¸°

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (ë” ì •í™•í•œ ë¶„ì„)

      # Java í™˜ê²½ ì„¤ì • (Semgrepì´ Java íŒŒì¼ íŒŒì‹±ì— í•„ìš”í•  ìˆ˜ ìˆìŒ)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5  # v5ê°€ ìµœì‹ 
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: |
          pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep SAST Scan
        run: |
          # Java ì „ìš© ë³´ì•ˆ ë£°ì…‹ ì‚¬ìš©
          semgrep scan \
            --config=p/java \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --sarif \
            --output=semgrep-results.sarif \
            --exclude="*.test.java" \
            --exclude="build/" \
            --exclude=".gradle/" \
            --exclude="gradle/" \
            --exclude="node_modules/" \
            --verbose
        continue-on-error: true # ì·¨ì•½ì ì„ ì°¾ì•„ë„ ë¹Œë“œë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ
    
      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          wait-for-processing: true
          category: semgrep

      # ê²°ê³¼ë¥¼ Artifactë¡œë„ ì €ì¥ (ì„ íƒì‚¬í•­)
      - name: Upload Semgrep Results as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-scan-results
          path: semgrep-results.sarif
          retention-days: 30

      # ìŠ¤ìº” ê²°ê³¼ ìš”ì•½ ì¶œë ¥
      - name: Print Scan Summary
        if: always()
        run: |
          echo "âœ… Semgrep ìŠ¤ìº” ì™„ë£Œ"
          echo "ğŸ“Š ê²°ê³¼ëŠ” Security íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”: ${{ github.server_url }}/${{ github.repository }}/security/code-scanning"