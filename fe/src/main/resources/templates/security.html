<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}">보안 리포트</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@microsoft/sarif-web-component@latest/dist/sarif-web-component.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .header { margin-bottom: 20px; }
        #sarif-viewer { min-height: 80vh; border: 1px solid #ccc; background: #fff; }
    </style>
</head>
<body>
    <div class="header">
        <h1>보안 분석 리포트</h1>
        <p>커밋: <code th:text="${commitSha}"></code></p>
        <p><a href="/">&larr; 홈으로 돌아가기</a></p>
    </div>

    <div id="sarif-viewer">
        <p style="padding: 20px;">보안 리포트를 불러오는 중...</p>
    </div>

    <script th:inline="javascript">
        // Thymeleaf 모델에서 SARIF 파일 URL 목록 주입
        const sarifFileUrls = /*[[${sarifFiles}]]*/ [];

        // SARIF 뷰어 컴포넌트
        const viewerElement = React.createElement(SarifWebComponent.Viewer, { 
            logs: [], // 초기값은 빈 배열
            showFilterbar: true 
        });
        
        const viewerContainer = document.getElementById('sarif-viewer');
        ReactDOM.render(viewerElement, viewerContainer);

        // 모든 SARIF 파일을 비동기적으로 S3에서 가져오기
        Promise.all(
            sarifFileUrls.map(url => 
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            console.error('Failed to fetch:', url);
                            return null; // 실패 시 null 반환
                        }
                        return response.json();
                    })
                    .catch(err => {
                        console.error('Error fetching', url, err);
                        return null; // 오류 시 null 반환
                    })
            )
        )
        .then(results => {
            // null을 제거하고 유효한 로그만 필터링
            const validLogs = results.filter(log => log !== null);
            
            if (validLogs.length > 0) {
                // S3에서 가져온 로그 데이터로 뷰어 업데이트
                const updatedViewerElement = React.createElement(SarifWebComponent.Viewer, {
                    logs: validLogs,
                    showFilterbar: true
                });
                ReactDOM.render(updatedViewerElement, viewerContainer);
            } else {
                viewerContainer.innerHTML = '<p style="padding: 20px; color: red;">보안 리포트를 불러오는 데 실패했습니다. S3 경로 또는 파일명을 확인하세요.</p>';
            }
        });
    </script>
</body>
</html>